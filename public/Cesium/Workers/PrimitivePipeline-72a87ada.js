define(["exports","./Transforms-f17097e5","./ComponentDatatype-ab629b88","./defaultValue-f6d5e6da","./Matrix3-b2351961","./GeometryAttribute-9c1a6bab","./GeometryAttributes-1e4ddcd2","./GeometryPipeline-a9233ae3","./IndexDatatype-a9b1bc18","./Matrix2-7a8e9daf","./WebMercatorProjection-db7467f4"],function(e,t,n,r,i,o,a,s,d,l,p){"use strict";function u(e,t,n){e=r.defaultValue(e,0),t=r.defaultValue(t,0),n=r.defaultValue(n,0),this.value=new Float32Array([e,t,n])}function f(e,t){let r=e.attributes,i=r.position,a=i.values.length/i.componentsPerAttribute;r.batchId=new o.GeometryAttribute({componentDatatype:n.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:new Float32Array(a)});let s=r.batchId.values;for(let e=0;e<a;++e)s[e]=t}function c(e,t,n,i){let o,a,s;let d=i.length-1;if(d>=0){let e=i[d];o=e.offset+e.count,a=n[s=e.index].indices.length}else o=0,a=n[s=0].indices.length;let l=e.length;for(let d=0;d<l;++d){let l=e[d][t];if(!r.defined(l))continue;let p=l.indices.length;o+p>a&&(o=0,a=n[++s].indices.length),i.push({index:s,offset:o,count:p}),o+=p}}Object.defineProperties(u.prototype,{componentDatatype:{get:function(){return n.ComponentDatatype.FLOAT}},componentsPerAttribute:{get:function(){return 3}},normalize:{get:function(){return!1}}}),u.fromCartesian3=function(e){return new u(e.x,e.y,e.z)},u.toValue=function(e,t){return r.defined(t)||(t=new Float32Array([e.x,e.y,e.z])),t[0]=e.x,t[1]=e.y,t[2]=e.z,t};let m={};function h(e){let n=e.length,i=1+(t.BoundingSphere.packedLength+1)*n,o=new Float32Array(i),a=0;o[a++]=n;for(let i=0;i<n;++i){let n=e[i];r.defined(n)?(o[a++]=1,t.BoundingSphere.pack(e[i],o,a)):o[a++]=0,a+=t.BoundingSphere.packedLength}return o}function g(e){let n=Array(e[0]),r=0,i=1;for(;i<e.length;)1===e[i++]&&(n[r]=t.BoundingSphere.unpack(e,i)),++r,i+=t.BoundingSphere.packedLength;return n}m.combineGeometry=function(e){let i,o;let a=e.instances,d=a.length,p,u,m=!1;d>0&&((i=function(e){let i=e.instances,o=e.projection,a=e.elementIndexUintSupported,d=e.scene3DOnly,p=e.vertexCacheOptimize,u=e.compressVertices,c=e.modelMatrix,m,h,g=i.length;for(m=0;m<g;++m)if(r.defined(i[m].geometry)){i[m].geometry.primitiveType;break}if(function(e,t,n){let i,o=!n,a=e.length;if(!o&&a>1){let t=e[0].modelMatrix;for(i=1;i<a;++i)if(!l.Matrix4.equals(t,e[i].modelMatrix)){o=!0;break}}if(o)for(i=0;i<a;++i)r.defined(e[i].geometry)&&s.GeometryPipeline.transformToWorldCoordinates(e[i]);else l.Matrix4.multiplyTransformation(t,e[0].modelMatrix,t)}(i,c,d),!d)for(m=0;m<g;++m)r.defined(i[m].geometry)&&s.GeometryPipeline.splitLongitude(i[m]);if(function(e){let t=e.length;for(let n=0;n<t;++n){let t=e[n];r.defined(t.geometry)?f(t.geometry,n):r.defined(t.westHemisphereGeometry)&&r.defined(t.eastHemisphereGeometry)&&(f(t.westHemisphereGeometry,n),f(t.eastHemisphereGeometry,n))}}(i),p)for(m=0;m<g;++m){let e=i[m];r.defined(e.geometry)?(s.GeometryPipeline.reorderForPostVertexCache(e.geometry),s.GeometryPipeline.reorderForPreVertexCache(e.geometry)):r.defined(e.westHemisphereGeometry)&&r.defined(e.eastHemisphereGeometry)&&(s.GeometryPipeline.reorderForPostVertexCache(e.westHemisphereGeometry),s.GeometryPipeline.reorderForPreVertexCache(e.westHemisphereGeometry),s.GeometryPipeline.reorderForPostVertexCache(e.eastHemisphereGeometry),s.GeometryPipeline.reorderForPreVertexCache(e.eastHemisphereGeometry))}let y=s.GeometryPipeline.combineInstances(i);for(g=y.length,m=0;m<g;++m){h=y[m];let e=h.attributes;if(d)for(let t in e)e.hasOwnProperty(t)&&e[t].componentDatatype===n.ComponentDatatype.DOUBLE&&s.GeometryPipeline.encodeAttribute(h,t,`${t}3DHigh`,`${t}3DLow`);else for(let i in e)if(e.hasOwnProperty(i)&&e[i].componentDatatype===n.ComponentDatatype.DOUBLE){let e=`${i}3D`,n=`${i}2D`;s.GeometryPipeline.projectTo2D(h,i,e,n,o),r.defined(h.boundingSphere)&&"position"===i&&(h.boundingSphereCV=t.BoundingSphere.fromVertices(h.attributes.position2D.values)),s.GeometryPipeline.encodeAttribute(h,e,`${e}High`,`${e}Low`),s.GeometryPipeline.encodeAttribute(h,n,`${n}High`,`${n}Low`)}u&&s.GeometryPipeline.compressVertices(h)}if(!a){let e=[];for(g=y.length,m=0;m<g;++m)h=y[m],e=e.concat(s.GeometryPipeline.fitToUnsignedShortIndices(h));y=e}return y}(e)).length>0&&(o=s.GeometryPipeline.createAttributeLocations(i[0]),e.createPickOffsets&&(p=function(e,t){let n=[];return c(e,"geometry",t,n),c(e,"westHemisphereGeometry",t,n),c(e,"eastHemisphereGeometry",t,n),n}(a,i))),r.defined(a[0].attributes)&&r.defined(a[0].attributes.offset)&&(u=Array(d),m=!0));let h=Array(d),g=Array(d);for(let e=0;e<d;++e){let n=a[e],i=n.geometry;r.defined(i)&&(h[e]=i.boundingSphere,g[e]=i.boundingSphereCV,m&&(u[e]=n.geometry.offsetAttribute));let o=n.eastHemisphereGeometry,s=n.westHemisphereGeometry;r.defined(o)&&r.defined(s)&&(r.defined(o.boundingSphere)&&r.defined(s.boundingSphere)&&(h[e]=t.BoundingSphere.union(o.boundingSphere,s.boundingSphere)),r.defined(o.boundingSphereCV)&&r.defined(s.boundingSphereCV)&&(g[e]=t.BoundingSphere.union(o.boundingSphereCV,s.boundingSphereCV)))}return{geometries:i,modelMatrix:e.modelMatrix,attributeLocations:o,pickOffsets:p,offsetInstanceExtend:u,boundingSpheres:h,boundingSpheresCV:g}},m.packCreateGeometryResults=function(e,n){let i=new Float64Array(function(e){let n=1,i=e.length;for(let o=0;o<i;o++){let i=e[o];if(++n,!r.defined(i))continue;let a=i.attributes;for(let e in n+=7+2*t.BoundingSphere.packedLength+(r.defined(i.indices)?i.indices.length:0),a)a.hasOwnProperty(e)&&r.defined(a[e])&&(n+=5+a[e].values.length)}return n}(e)),o=[],a={},s=e.length,d=0;i[d++]=s;for(let n=0;n<s;n++){let s=e[n],l=r.defined(s);if(i[d++]=l?1:0,!l)continue;i[d++]=s.primitiveType,i[d++]=s.geometryType,i[d++]=r.defaultValue(s.offsetAttribute,-1);let p=r.defined(s.boundingSphere)?1:0;i[d++]=p,p&&t.BoundingSphere.pack(s.boundingSphere,i,d),d+=t.BoundingSphere.packedLength;let u=r.defined(s.boundingSphereCV)?1:0;i[d++]=u,u&&t.BoundingSphere.pack(s.boundingSphereCV,i,d),d+=t.BoundingSphere.packedLength;let f=s.attributes,c=[];for(let e in f)f.hasOwnProperty(e)&&r.defined(f[e])&&(c.push(e),r.defined(a[e])||(a[e]=o.length,o.push(e)));i[d++]=c.length;for(let e=0;e<c.length;e++){let t=c[e],n=f[t];i[d++]=a[t],i[d++]=n.componentDatatype,i[d++]=n.componentsPerAttribute,i[d++]=n.normalize?1:0,i[d++]=n.values.length,i.set(n.values,d),d+=n.values.length}let m=r.defined(s.indices)?s.indices.length:0;i[d++]=m,m>0&&(i.set(s.indices,d),d+=m)}return n.push(i.buffer),{stringTable:o,packedData:i}},m.unpackCreateGeometryResults=function(e){let r;let i=e.stringTable,s=e.packedData,l=Array(s[0]),p=0,u=1;for(;u<s.length;){let e,f,c,m;if(1!==s[u++]){l[p++]=void 0;continue}let h=s[u++],g=s[u++],y,b,x=s[u++];-1===x&&(x=void 0),1===s[u++]&&(y=t.BoundingSphere.unpack(s,u)),u+=t.BoundingSphere.packedLength,1===s[u++]&&(b=t.BoundingSphere.unpack(s,u)),u+=t.BoundingSphere.packedLength;let G=new a.GeometryAttributes,S=s[u++];for(r=0;r<S;r++){let t=i[s[u++]],r=s[u++];c=s[u++];let a=0!==s[u++];e=s[u++],f=n.ComponentDatatype.createTypedArray(r,e);for(let t=0;t<e;t++)f[t]=s[u++];G[t]=new o.GeometryAttribute({componentDatatype:r,componentsPerAttribute:c,normalize:a,values:f})}if((e=s[u++])>0){let t=f.length/c;for(m=d.IndexDatatype.createTypedArray(t,e),r=0;r<e;r++)m[r]=s[u++]}l[p++]=new o.Geometry({primitiveType:h,geometryType:g,boundingSphere:y,boundingSphereCV:b,indices:m,attributes:G,offsetAttribute:x})}return l},m.packCombineGeometryParameters=function(e,n){let i=e.createGeometryResults,o=i.length;for(let e=0;e<o;e++)n.push(i[e].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:function(e,t){let n=e.length,i=new Float64Array(1+19*n),o=0;i[o++]=n;for(let t=0;t<n;t++){let n=e[t];if(l.Matrix4.pack(n.modelMatrix,i,o),o+=l.Matrix4.packedLength,r.defined(n.attributes)&&r.defined(n.attributes.offset)){let e=n.attributes.offset.value;i[o]=e[0],i[o+1]=e[1],i[o+2]=e[2]}o+=3}return t.push(i.buffer),i}(e.instances,n),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof t.GeographicProjection,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets}},m.unpackCombineGeometryParameters=function(e){let n=function(e){let t=Array(e[0]),n=0,i=1;for(;i<e.length;){let o;let a=l.Matrix4.unpack(e,i);i+=l.Matrix4.packedLength,r.defined(e[i])&&(o={offset:new u(e[i],e[i+1],e[i+2])}),i+=3,t[n++]={modelMatrix:a,attributes:o}}return t}(e.packedInstances),o=e.createGeometryResults,a=o.length,s=0;for(let e=0;e<a;e++){let t=m.unpackCreateGeometryResults(o[e]),r=t.length;for(let e=0;e<r;e++){let r=t[e];n[s].geometry=r,++s}}let d=i.Ellipsoid.clone(e.ellipsoid);return{instances:n,ellipsoid:d,projection:e.isGeographic?new t.GeographicProjection(d):new p.WebMercatorProjection(d),elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:l.Matrix4.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets}},m.packCombineGeometryResults=function(e,t){r.defined(e.geometries)&&function(e,t){let n=e.length;for(let i=0;i<n;++i)(function(e,t){let n=e.attributes;for(let e in n)if(n.hasOwnProperty(e)){let i=n[e];r.defined(i)&&r.defined(i.values)&&t.push(i.values.buffer)}r.defined(e.indices)&&t.push(e.indices.buffer)})(e[i],t)}(e.geometries,t);let n=h(e.boundingSpheres),i=h(e.boundingSpheresCV);return t.push(n.buffer,i.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:n,boundingSpheresCV:i}},m.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:g(e.boundingSpheres),boundingSpheresCV:g(e.boundingSpheresCV)}},e.PrimitivePipeline=m});